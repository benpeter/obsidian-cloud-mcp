#cloud-config

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose-v2
  - curl
  - git
  - jq

write_files:
  - path: /opt/obsidian-mcp/.env
    permissions: '0600'
    content: |
      # Domain for HTTPS (Caddy)
      MCP_DOMAIN=${mcp_domain}

      # Cloudflare Worker (OAuth + Token Introspection)
      CLOUDFLARE_WORKER_URL=${cloudflare_worker_url}

      # Obsidian REST API Key - configure after Obsidian setup
      OBSIDIAN_API_KEY=not_configured_yet

      # Web GUI Authentication
      VNC_PASSWORD=${vnc_password}

  - path: /opt/obsidian-mcp/setup-complete.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      echo "=========================================="
      echo "Obsidian MCP Server - Setup Complete"
      echo "=========================================="
      echo ""
      echo "SECURITY: OAuth + HTTPS enabled"
      echo ""
      echo "Server is running. Next steps:"
      echo ""
      echo "1. Access Obsidian GUI:"
      echo "   https://$(curl -s ifconfig.me):3001"
      echo "   Username: admin"
      echo "   Password: (from VNC_PASSWORD secret)"
      echo ""
      echo "2. Login to Obsidian Sync"
      echo ""
      echo "3. Install 'Local REST API' plugin"
      echo "   - Enable 'Bind to all interfaces'"
      echo "   - Copy the API key"
      echo ""
      echo "4. Run the 'Configure API Key' GitHub workflow"
      echo "   OR manually update /opt/obsidian-mcp/.env"
      echo ""
      echo "5. MCP Server is available at:"
      echo "   https://${mcp_domain}"
      echo ""
      echo "6. Add MCP connector in Claude.ai:"
      echo "   Server URL: https://${mcp_domain}/mcp"
      echo ""
      echo "=========================================="

runcmd:
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker

  # Create directory structure
  - mkdir -p /opt/obsidian-mcp

  # Clone repository files
  - git clone --depth 1 https://github.com/benpeter/obsidian-cloud-mcp.git /tmp/obsidian-setup
  - cp -r /tmp/obsidian-setup/docker/* /opt/obsidian-mcp/
  - cp -r /tmp/obsidian-setup/mcp-server /opt/obsidian-mcp/
  - cp -r /tmp/obsidian-setup/scripts /opt/obsidian-mcp/
  - rm -rf /tmp/obsidian-setup

  # Create data directories
  - mkdir -p /opt/obsidian-mcp/config
  - mkdir -p /opt/obsidian-mcp/vault

  # Start containers (Caddy will auto-obtain SSL certificate)
  - cd /opt/obsidian-mcp && docker compose up -d --build

  # Show completion message
  - /opt/obsidian-mcp/setup-complete.sh

final_message: |
  Obsidian MCP Server deployment complete!
  MCP Endpoint: https://${mcp_domain}
  GUI Access: https://$PUBLIC_IP:3001
  OAuth authentication is ENABLED via Cloudflare Worker.
