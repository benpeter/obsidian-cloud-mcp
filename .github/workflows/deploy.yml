name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      server_type:
        description: 'Server type (cx23 = 2vCPU/4GB, cx33 = 4vCPU/8GB)'
        required: false
        default: 'cx23'
        type: choice
        options:
          - cx23
          - cx33
      server_location:
        description: 'Server location'
        required: false
        default: 'nbg1'
        type: choice
        options:
          - nbg1  # Nuremberg
          - fsn1  # Falkenstein
          - hel1  # Helsinki
      enable_ipv4:
        description: 'Enable IPv4 address (+â‚¬0.50/month). Disable for IPv6-only.'
        required: false
        default: true
        type: boolean

env:
  TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_vnc_password: ${{ secrets.VNC_PASSWORD }}
  TF_VAR_mcp_jwt_secret: ${{ secrets.MCP_JWT_SECRET }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        id: init
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        run: |
          terraform plan \
            -var="server_type=${{ inputs.server_type }}" \
            -var="server_location=${{ inputs.server_location }}" \
            -var="enable_ipv4=${{ inputs.enable_ipv4 }}" \
            -out=tfplan

      - name: Terraform Apply
        id: apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: Get Outputs
        working-directory: terraform
        id: outputs
        run: |
          echo "server_ipv4=$(terraform output -raw server_ipv4)" >> $GITHUB_OUTPUT
          echo "server_ipv6=$(terraform output -raw server_ipv6)" >> $GITHUB_OUTPUT
          echo "vnc_url=$(terraform output -raw vnc_url)" >> $GITHUB_OUTPUT
          echo "mcp_endpoint=$(terraform output -raw mcp_endpoint)" >> $GITHUB_OUTPUT
          echo "ip_mode=$(terraform output -raw ip_mode)" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Server Details" >> $GITHUB_STEP_SUMMARY
          echo "- **IP Mode:** ${{ steps.outputs.outputs.ip_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv4:** \`${{ steps.outputs.outputs.server_ipv4 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv6:** \`${{ steps.outputs.outputs.server_ipv6 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **VNC URL:** ${{ steps.outputs.outputs.vnc_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MCP Endpoint:** ${{ steps.outputs.outputs.mcp_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Authentication" >> $GITHUB_STEP_SUMMARY
          echo "Both services require authentication:" >> $GITHUB_STEP_SUMMARY
          echo "- **Web GUI:** Basic Auth (user: \`admin\`, password: \`VNC_PASSWORD\` secret)" >> $GITHUB_STEP_SUMMARY
          echo "- **MCP Server:** JWT Bearer token (secret: \`MCP_JWT_SECRET\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait 2-3 minutes for Docker containers to start" >> $GITHUB_STEP_SUMMARY
          echo "2. Open the VNC URL and log in (user: \`admin\`)" >> $GITHUB_STEP_SUMMARY
          echo "3. Log in to Obsidian Sync manually" >> $GITHUB_STEP_SUMMARY
          echo "4. Install and configure the 'Local REST API' plugin" >> $GITHUB_STEP_SUMMARY
          echo "   - Enable 'Bind to all interfaces'" >> $GITHUB_STEP_SUMMARY
          echo "   - Copy the API key" >> $GITHUB_STEP_SUMMARY
          echo "5. Run the 'Configure API Key' workflow with the copied key" >> $GITHUB_STEP_SUMMARY
          echo "6. Generate JWT token: \`./scripts/generate-jwt.sh <MCP_JWT_SECRET> 720\`" >> $GITHUB_STEP_SUMMARY
          echo "7. Use the JWT token in your MCP client configuration" >> $GITHUB_STEP_SUMMARY

      - name: Save Terraform State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: |
            terraform/terraform.tfstate
            terraform/terraform.tfstate.backup
          retention-days: 90
          if-no-files-found: warn

      # Cleanup on failure - destroy any partially created resources
      - name: Cleanup on Failure
        if: failure() && steps.init.outcome == 'success'
        working-directory: terraform
        run: |
          echo "## âš ï¸ Deployment Failed - Cleaning Up" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Destroying partially created resources..." >> $GITHUB_STEP_SUMMARY

          terraform destroy -auto-approve \
            -var="server_type=${{ inputs.server_type }}" \
            -var="server_location=${{ inputs.server_location }}" \
            -var="enable_ipv4=${{ inputs.enable_ipv4 }}" \
            || echo "Cleanup completed (some resources may not have existed)"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cleanup complete. Fix the error and re-run the workflow." >> $GITHUB_STEP_SUMMARY
