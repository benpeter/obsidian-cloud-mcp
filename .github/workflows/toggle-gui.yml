name: Toggle Web GUI Access

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Enable or disable Web GUI access'
        required: true
        type: choice
        options:
          - disable
          - enable
      server_ip:
        description: 'Server IP address (leave empty to use Terraform state)'
        required: false
        type: string

env:
  TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}

jobs:
  toggle-gui:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        if: inputs.server_ip == ''
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Download Terraform State
        if: inputs.server_ip == ''
        uses: actions/download-artifact@v4
        with:
          name: terraform-state
          path: terraform/
        continue-on-error: true

      - name: Terraform Init
        if: inputs.server_ip == ''
        working-directory: terraform
        run: terraform init

      - name: Get Server IP
        id: server
        working-directory: terraform
        run: |
          if [ -n "${{ inputs.server_ip }}" ]; then
            echo "ip=${{ inputs.server_ip }}" >> $GITHUB_OUTPUT
          else
            IPV4=$(terraform output -raw server_ipv4 2>/dev/null || echo '')
            if [ -n "$IPV4" ] && [ "$IPV4" != "IPv4 disabled" ]; then
              echo "ip=$IPV4" >> $GITHUB_OUTPUT
            else
              echo "ip=$(terraform output -raw server_ipv6 2>/dev/null)" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.server.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Disable GUI Access
        if: inputs.action == 'disable'
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ steps.server.outputs.ip }} << 'EOF'
          echo "Blocking Web GUI port 3001..."

          # Docker publishes ports via NAT/FORWARD, not INPUT.
          # The DOCKER-USER chain is the correct place to block traffic
          # to Docker-published ports (see Docker docs on iptables).

          # Clean up any stale INPUT rules from previous runs
          iptables -D INPUT -p tcp --dport 3001 -j DROP 2>/dev/null || true
          iptables -D INPUT -p tcp --dport 3001 -j DROP 2>/dev/null || true
          ip6tables -D INPUT -p tcp --dport 3001 -j DROP 2>/dev/null || true
          ip6tables -D INPUT -p tcp --dport 3001 -j DROP 2>/dev/null || true

          # Block via DOCKER-USER chain (idempotent: remove first, then add)
          iptables -D DOCKER-USER -p tcp --dport 3001 -j DROP 2>/dev/null || true
          iptables -I DOCKER-USER -p tcp --dport 3001 -j DROP

          ip6tables -D DOCKER-USER -p tcp --dport 3001 -j DROP 2>/dev/null || true
          ip6tables -I DOCKER-USER -p tcp --dport 3001 -j DROP 2>/dev/null || true

          # Save rules to persist across reboots
          if command -v netfilter-persistent &> /dev/null; then
            netfilter-persistent save
          fi

          echo "GUI access disabled via DOCKER-USER chain."
          EOF

      - name: Enable GUI Access
        if: inputs.action == 'enable'
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ steps.server.outputs.ip }} << 'EOF'
          echo "Unblocking Web GUI port 3001..."

          # Remove DOCKER-USER DROP rules
          iptables -D DOCKER-USER -p tcp --dport 3001 -j DROP 2>/dev/null || true
          ip6tables -D DOCKER-USER -p tcp --dport 3001 -j DROP 2>/dev/null || true

          # Also clean up any stale INPUT rules
          iptables -D INPUT -p tcp --dport 3001 -j DROP 2>/dev/null || true
          ip6tables -D INPUT -p tcp --dport 3001 -j DROP 2>/dev/null || true

          # Save rules
          if command -v netfilter-persistent &> /dev/null; then
            netfilter-persistent save
          fi

          echo "GUI access enabled on port 3001 (HTTPS)."
          echo "Login: admin / <VNC_PASSWORD>"
          EOF

      - name: Verify Status
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ steps.server.outputs.ip }} << 'EOF'
          echo ""
          echo "=== DOCKER-USER chain (controls Docker port access) ==="
          iptables -L DOCKER-USER -n | grep "3001" || echo "No DROP rule for 3001 (GUI accessible)"
          echo ""
          echo "=== Container status ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(NAMES|obsidian)"
          EOF

      - name: Summary
        run: |
          echo "## Web GUI Access: ${{ inputs.action }}d" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.action }}" == "disable" ]; then
            echo "### Status" >> $GITHUB_STEP_SUMMARY
            echo "- Port 3001 (HTTPS GUI): **Blocked** (via DOCKER-USER chain)" >> $GITHUB_STEP_SUMMARY
            echo "- MCP Server: **Still accessible** via Caddy (443)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run this workflow with 'enable' to restore GUI access." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status" >> $GITHUB_STEP_SUMMARY
            echo "- Port 3001 (HTTPS GUI): **Open**" >> $GITHUB_STEP_SUMMARY
            echo "- MCP Server: **Open** via Caddy (443)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Access" >> $GITHUB_STEP_SUMMARY
            echo "- URL: \`https://${{ steps.server.outputs.ip }}:3001\`" >> $GITHUB_STEP_SUMMARY
            echo "- Username: \`admin\`" >> $GITHUB_STEP_SUMMARY
            echo "- Password: Your \`VNC_PASSWORD\` secret" >> $GITHUB_STEP_SUMMARY
          fi
